#!/bin/bash

# Exit on errors
set -e

# Ensure required tools are installed
command -v gum >/dev/null 2>&1 || { echo "gum is not installed. Install it first: brew install gum"; exit 1; }
command -v kubectl >/dev/null 2>&1 || { echo "kubectl is not installed. Install it first."; exit 1; }
command -v openssl >/dev/null 2>&1 || { echo "openssl is not installed. Install it first."; exit 1; }

# Fetch existing namespaces and add "New" option
NAMESPACES=$(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}')
NAMESPACE_SELECTION=$(echo -e "New\n$NAMESPACES" | tr ' ' '\n' | gum choose --header "Select a Kubernetes namespace")

# If user selects "New", prompt for a new namespace name and create it
if [ "$NAMESPACE_SELECTION" == "New" ]; then
  NAMESPACE=$(gum input --placeholder "Enter the new namespace name")
  gum confirm "Create new namespace '$NAMESPACE'?" || exit 1
  kubectl create namespace "$NAMESPACE"
  gum style --border rounded --margin "1" --padding "1" --border-foreground 212 "Namespace '$NAMESPACE' created successfully!"
else
  NAMESPACE="$NAMESPACE_SELECTION"
fi

# Prompt user for secret name
SECRET_NAME=$(gum input --placeholder "Enter the secret name" --value "istio-tls-secret")

# Set certificate details
CERT_DIR="./tls"
mkdir -p $CERT_DIR
CERT_FILE="$CERT_DIR/tls.crt"
KEY_FILE="$CERT_DIR/tls.key"

# Generate a new TLS certificate using OpenSSL
gum spin --spinner line --title "Generating TLS certificate..." -- \
  openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout "$KEY_FILE" -out "$CERT_FILE" \
  -subj "/CN=example.com/O=MyOrg"

# Display generated files
gum style --border rounded --margin "1" --padding "1" --border-foreground 212 "TLS Certificate and Key Generated Successfully!"

# Confirm before creating the Kubernetes secret
gum confirm "Create Kubernetes secret '$SECRET_NAME' in namespace '$NAMESPACE'?" || exit 1

# Create the Kubernetes TLS secret
kubectl create secret tls "$SECRET_NAME" \
  --namespace "$NAMESPACE" \
  --key="$KEY_FILE" \
  --cert="$CERT_FILE"

# Success message
gum style --border double --margin "1" --padding "1" --border-foreground 10 "Kubernetes TLS Secret '$SECRET_NAME' created successfully in namespace '$NAMESPACE'!"

# Clean up (optional)
rm -r $CERT_DIR