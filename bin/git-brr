#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# 1. Are we in a git repo?
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  echo "⛔ Not a git repository."
  exit 1
fi

# 2. Is the working tree clean? If not, show git status and exit.
if ! git diff --quiet || ! git diff --cached --quiet; then
  gum style --foreground=1 "⛔ Working directory is dirty. Please commit or stash changes first."
  git status
  exit 1
fi

# 3. Collect the 20 most-recent branches
branches=()
while IFS= read -r branch; do
  branches+=("$branch")
done < <(
  git for-each-ref \
    --format='%(refname:short)' \
    --sort=-committerdate \
    refs/heads/ |
  head -n 20
)

# 4. Colorize release-* and let gum choose
selected=$( 
  for branch in "${branches[@]}"; do
    if [[ "$branch" == release-* ]]; then
      # ANSI yellow
      printf '\033[33m%s\033[0m\n' "$branch"
    else
      printf '%s\n' "$branch"
    fi
  done | gum choose
)

# 5. Strip ANSI codes from the chosen line
plain_branch=$(printf '%s' "$selected" | sed -r 's/\x1B\[[0-9;]*m//g')

if [[ -z "$plain_branch" ]]; then
  echo "⚠️  No branch selected."
  exit 1
fi

# 6. Checkout
git checkout "$plain_branch"